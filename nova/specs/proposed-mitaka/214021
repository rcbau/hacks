From 827b6395d5a26a45482390fc1fa9b663111980cc Mon Sep 17 00:00:00 2001
From: Wen Zhi Yu <yuywz@cn.ibm.com>
Date: Tue, 18 Aug 2015 13:56:10 +0800
Subject: [PATCH] Spec for nova API blueprint
 correct-volume-attachment-id-in-nova-api-volumes

APIImpact
Partially Implements: blueprint correct-volume-attachment-id-in-nova-api-volumes
Related-Bug: 1480131

Co-authored-by: Park_heijlong <heijlong@linux.vnet.ibm.com>

Change-Id: I2e61e5e753115f165b94be851219f52dab2b8560
---
 ...ct-volume-attachment-id-in-nova-api-volumes.rst | 191 +++++++++++++++++++++
 1 file changed, 191 insertions(+)
 create mode 100644 specs/mitaka/approved/correct-volume-attachment-id-in-nova-api-volumes.rst

diff --git a/specs/mitaka/approved/correct-volume-attachment-id-in-nova-api-volumes.rst b/specs/mitaka/approved/correct-volume-attachment-id-in-nova-api-volumes.rst
new file mode 100644
index 0000000..15013ce
--- /dev/null
+++ b/specs/mitaka/approved/correct-volume-attachment-id-in-nova-api-volumes.rst
@@ -0,0 +1,191 @@
+..
+ This work is licensed under a Creative Commons Attribution 3.0 Unported
+ License.
+
+ http://creativecommons.org/licenses/by/3.0/legalcode
+
+=================================================
+Correct volume_attachment_id in nova API volumes
+=================================================
+
+https://blueprints.launchpad.net/nova/+spec/correct-volume-attachment-id-in-nova-api-volumes
+
+In REST api GET response of Nova api VolumeAttachmentController,
+return 'id' of cinder.objects.volume_attachment.VolumeAttachment
+instead of 'id' of cinder.objects.volume.Volume so that cloud admins
+can easily identify them.
+
+Problem description
+===================
+
+Currently in Nova api, when create/index/show method of
+VolumeAttachmentController returns 'VolumeAttachment' info in api
+response, they assign 'id' of 'VolumeAttachment' with the 'id' value
+of the volume itself, see [1].
+[1]https://github.com/openstack/nova/blob/master/nova/api/openstack/compute/volumes.py#L218-L219
+
+So the value of 'id' for 'VolumeAttachment' returned by nova API
+is not corresponding to the ideal value for the attachment as designed. This
+makes the confusion for the management especially. The actual value of 'id'
+attribute of 'VolumeAttachment' is generated by cinder when the attachment
+happens, cinder stores the 'id' into database table 'volume_attachment'.
+
+Use Cases
+----------
+
+As a cloud administrator, I need to know the volume attachment info about the
+instances, I need to distinguish the attachments by ‘id’ attribute of them.
+
+Project Priority
+-----------------
+
+None
+
+Proposed change
+===============
+
+For 'index'/'show' method of VolumeAttachmentController, nova should get
+the value of ‘id’ attribute of this attachment from cinder and assign it
+to ‘id’ attribute of ‘VolumeAttachment’.
+
+For 'create' method of VolumeAttachmentController, because the volume attach
+request(RPC cast) is async, 'create' method will return without waiting for
+the attachment process completes. However, the 'id' attribute of this
+attachment will not be generated until attachment process completes. Thus we
+can exclude the 'id' attribute of attachment from the return value. User can
+get it via 'index' method after the attach process completes.
+
+For nova.volume.cinder.API, update the '_untranslate_volume_summary_view'
+method to add 'attachment_id' attribute in volume summary info. Then nova
+can get this attribute for creating/listing/showing 'VolumeAttachment'.
+
+Alternatives
+------------
+
+None
+
+Data model impact
+-----------------
+
+None
+
+REST API impact
+---------------
+
+The proposed change will add a microversion for updating the GET response
+data of 'index'/'show' method in VolumeAttachmentConroller and POST response
+data of 'create' method in VolumeAttachmentController to correct the value
+of ‘id’ attribute.
+
+The details will be changed in the volumes API extension.
+
+If a user is using the required minimum version of the API to get the
+actual volume attachment ‘id’ data, they can begin to use it, otherwise
+they won’t see any change.
+
+Example use cases:
+Request:
+GET -header “X-OpenStack-Nova_API-Version: 2.XX” v2.1/{tenant_id}/servers/
+{server_id}/os-volume_attachments
+
+Response:
+
+{"volumeAttachments" : [{\
+    "device" : "/dev/vdb",\
+    "serverId" : "56293904-9384-48f8-9329-c961056583f1",\
+    "id" : "eccbec42-732a-42ff-90e5-e505af1ca22",\
+    "volumeId" : "a75bec42-77b5-42ff-90e5-e505af14b84a"\
+    }]}
+
+There should note be any impacts to policy.json files for this change.
+
+Security impact
+---------------
+
+None
+
+Notifications impact
+--------------------
+
+None
+
+Other end user impact
+---------------------
+
+None
+
+Performance Impact
+------------------
+
+None
+
+Other deployer impact
+---------------------
+
+None
+
+Developer impact
+----------------
+
+None
+
+
+Implementation
+==============
+
+Assignee(s)
+-----------
+
+Primary assignee:
+  Wen Zhi Yu <yuywz@cn.ibm.com>
+
+Other contributors:
+  Park heijlong <heijlong@linux.vnet.ibm.com>
+
+Work Items
+----------
+
+Update relative method in nova.volume.cinder.py to add 'attachment_id'
+attribute in volume info.
+
+Update 'create'/'show'/'index' method of 'VolumeAttachmentController'
+in nova API, correct the value of ‘id’ attribute of ‘VolumeAttachment’.
+
+
+Dependencies
+============
+
+None
+
+
+Testing
+=======
+
+Unit tests and possibly API samples functional tests in the nova tree.
+
+There are currently not any test cases for verifying the ‘id’ of
+volume attachment in Tempest. We could add corresponding test case in
+Tempest with microversion support.
+
+
+Documentation Impact
+====================
+
+The nova/api/openstack/rest_api_version_history.rst document
+will be updated.
+
+
+References
+==========
+
+Originally reported as a bug: https://bugs.launchpad.net/nova/+bug/1480131
+
+correct-volume-attachment-id-in-nova-api-volumes blueprint:
+https://blueprints.launchpad.net/nova/+spec/correct-volume-attachment-id-in-
+nova-api-volumes
+
+
+History
+=======
+
+None
-- 
2.1.0

