From 8189af1f11125dbd1edff3e049af31fdc198097b Mon Sep 17 00:00:00 2001
From: Sylvain Bauza <sbauza@redhat.com>
Date: Wed, 8 Oct 2014 15:13:29 +0200
Subject: [PATCH] Propose Detach Service from ComputeNode

As this patch series requires DB migrations, a spec is proposed.

Change-Id: Ia261e9e15ac5596a1d0d5057ba5efbb0bab66833
---
 .../approved/detach-service-from-computenode.rst   | 153 +++++++++++++++++++++
 1 file changed, 153 insertions(+)
 create mode 100644 specs/kilo/approved/detach-service-from-computenode.rst

diff --git a/specs/kilo/approved/detach-service-from-computenode.rst b/specs/kilo/approved/detach-service-from-computenode.rst
new file mode 100644
index 0000000..e2db13e
--- /dev/null
+++ b/specs/kilo/approved/detach-service-from-computenode.rst
@@ -0,0 +1,153 @@
+..
+ This work is licensed under a Creative Commons Attribution 3.0 Unported
+ License.
+
+ http://creativecommons.org/licenses/by/3.0/legalcode
+
+================================
+Detach Service from Compute_Node
+================================
+
+https://blueprints.launchpad.net/nova/+spec/detach-service-from-computenode
+
+Remove the nested dependency in between Service and ComputeNode
+
+Problem description
+===================
+
+There is no good reason to keep a dependency in between a service, which is the
+representation of the message bus and a compute_node, which is a collection of
+resources for the solely use of the scheduler. It also creates a dependency
+in the internals of the Scheduler, while it is useless for it.
+The only reason why such a dependency exists is because there is a 1:N
+relationship in between a host and multiple nodes, but this representation
+should be present directly in compute_nodes table as a unique key for
+(host, node).
+
+Use Cases
+---------
+
+N/A
+
+Project Priority
+----------------
+
+Priorities not yet set, but this work is related to the effort of reducing
+technical debt.
+
+Proposed change
+===============
+
+Instead of having a relationship using a foreign key, the proposal will consist
+of adding a new field called 'host' for compute_nodes and a unique constraint
+on (host, hypervisor_hostname). Also, service_id field will be removed from
+compute_nodes table and object, SQLA relationship on service will be deleted
+and Service object will no longer have a compute_node field.
+
+Alternatives
+------------
+
+Leave the data model unchanged but act only at Object model could be possible,
+but would mean that Objects fields and DB fields are not identical.
+
+Data model impact
+-----------------
+
+Most of the change is about changing the model, but let's rephrase it.
+compute_nodes.service_id and compute_nodes.service relationship
+will be deleted, and compute_nodes.host will be added as a String (identical
+to Service.host field).
+DB migrations will ensure that :
+
+ - host will be populated at upgrade using Service.host table thanks to
+   existing service_id
+
+ - service_id will be populated at downgrade using host information that
+   matches Service.host
+
+REST API impact
+---------------
+
+In order to preserve API stability, extra calls will be made at the API level
+for querying service state and adding it to the response model when asking
+for compute_nodes or querying compute_nodes when asking for service.
+
+No changes in the API model.
+
+Security impact
+---------------
+
+None
+
+Notifications impact
+--------------------
+
+None
+
+Other end user impact
+---------------------
+
+None
+
+Performance Impact
+------------------
+
+Extra calls will be made when querying specific API endpoints (hypervisors and
+services) when wanting to get the list, but these endpoints are admin-only and
+not really used for production workloads or management.
+
+Other deployer impact
+---------------------
+None
+
+Developer impact
+----------------
+
+None
+
+Implementation
+==============
+
+Assignee(s)
+-----------
+
+Primary assignee:
+    sbauza
+
+Other contributors:
+    None
+
+Work Items
+----------
+
+Code was already posted as a patch series [1] :
+
+* Add host field to compute_nodes table
+* Add extra methods for querying this new field
+* Use these extra methods instead of querying Service for getting the node(s)
+* Modify calls for getting service info instead of looking at the compute
+  object directly
+* Remove service_id field from compute_nodes and service relationship
+
+Dependencies
+============
+
+None
+
+Testing
+=======
+
+Current Tempest and unittests already cover this.
+
+Documentation Impact
+====================
+
+None
+
+References
+==========
+
+Formerly it was a bug:
+https://bugs.launchpad.net/nova/+bug/1357491
+
+[1]: https://review.openstack.org/#q,topic:bp/detach-service-from-computenode,n,z
\ No newline at end of file
-- 
1.9.1

